<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TweetAgent â€” Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={theme:{extend:{colors:{brand:'#818cf8','brand-2':'#a78bfa','brand-3':'#c084fc'}}}}</script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --ink: #050505;
            --surface: rgba(255,255,255,0.03);
            --surface-2: rgba(255,255,255,0.05);
            --border: rgba(255,255,255,0.06);
            --border-bright: rgba(255,255,255,0.12);
            --text-1: #f0eee6;
            --text-2: rgba(240,238,230,0.5);
            --text-3: rgba(240,238,230,0.25);
            --accent: #818cf8;
            --accent-2: #a78bfa;
            --accent-3: #c084fc;
            --green: #4ade80;
            --red: #f87171;
            --yellow: #fbbf24;
        }

        body {
            background: var(--ink);
            color: var(--text-1);
            font-family: 'DM Sans', system-ui, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* â”€â”€ Ambient â”€â”€ */
        .ambient { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
        .orb { position: absolute; border-radius: 50%; filter: blur(140px); opacity: 0.2; }
        .orb-1 { width: 500px; height: 500px; background: radial-gradient(circle, var(--accent), transparent 70%); top: -10%; right: 10%; animation: drift1 30s ease-in-out infinite; }
        .orb-2 { width: 400px; height: 400px; background: radial-gradient(circle, var(--accent-3), transparent 70%); bottom: -10%; left: -5%; animation: drift2 25s ease-in-out infinite; }
        @keyframes drift1 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(-60px,40px)} }
        @keyframes drift2 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(40px,-30px)} }

        .grain {
            position: fixed; inset: 0; z-index: 1; pointer-events: none; opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-repeat: repeat; background-size: 256px;
        }

        /* â”€â”€ Glass cards â”€â”€ */
        .glass {
            background: var(--surface);
            backdrop-filter: blur(40px) saturate(1.2);
            -webkit-backdrop-filter: blur(40px) saturate(1.2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.75rem;
            transition: border-color 0.3s, transform 0.3s;
        }
        .glass:hover { border-color: var(--border-bright); }
        .glass-glow {
            box-shadow: 0 0 40px rgba(129,140,248,0.06), inset 0 1px 0 rgba(255,255,255,0.04);
        }

        /* â”€â”€ Typography â”€â”€ */
        .font-display { font-family: 'Syne', sans-serif; }
        .section-title {
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: -0.01em;
        }
        .section-sub {
            font-size: 0.8rem;
            color: var(--text-2);
            margin-top: 0.2rem;
        }
        .label { font-size: 0.78rem; color: var(--text-2); margin-bottom: 0.35rem; }
        .help-text { font-size: 0.68rem; color: var(--text-3); margin-top: 0.2rem; }
        .help-text a { color: var(--accent-2); text-decoration: none; }
        .help-text a:hover { text-decoration: underline; }

        /* â”€â”€ Inputs â”€â”€ */
        input, select, textarea {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            color: var(--text-1);
            border-radius: 10px;
            padding: 0.6rem 0.75rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.82rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(129,140,248,0.1);
        }
        input::placeholder, textarea::placeholder { color: var(--text-3); }
        select { cursor: pointer; }
        select option { background: #111; color: var(--text-1); }

        /* â”€â”€ Buttons â”€â”€ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.6rem 1.25rem;
            font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: 0.82rem;
            border: none; border-radius: 10px; cursor: pointer;
            transition: all 0.25s cubic-bezier(0.16,1,0.3,1);
            text-decoration: none; color: white; line-height: 1;
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-brand {
            background: linear-gradient(135deg, var(--accent), var(--accent-3));
            box-shadow: 0 2px 12px rgba(129,140,248,0.2);
        }
        .btn-brand:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(129,140,248,0.3);
        }

        .btn-danger {
            background: rgba(248,113,113,0.15);
            color: var(--red);
            border: 1px solid rgba(248,113,113,0.2);
        }
        .btn-danger:hover:not(:disabled) { background: rgba(248,113,113,0.25); transform: translateY(-1px); }

        .btn-ghost {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text-2);
        }
        .btn-ghost:hover:not(:disabled) { background: rgba(255,255,255,0.08); border-color: var(--border-bright); color: var(--text-1); }

        .btn-full { width: 100%; }

        /* â”€â”€ Status dots â”€â”€ */
        .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .dot-green { background: var(--green); box-shadow: 0 0 8px rgba(74,222,128,0.4); }
        .dot-red { background: var(--red); }
        .dot-yellow { background: var(--yellow); }
        .dot-pulse { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* â”€â”€ Badges â”€â”€ */
        .badge {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-size: 0.72rem; font-weight: 500;
        }
        .badge-green { background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.2); color: var(--green); }
        .badge-gray { background: var(--surface-2); border: 1px solid var(--border); color: var(--text-2); }
        .badge-brand { background: rgba(129,140,248,0.1); border: 1px solid rgba(129,140,248,0.2); color: var(--accent); }

        /* â”€â”€ Spinner â”€â”€ */
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: none;
        }
        .spinner.active { display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Robot (small, for header) â”€â”€ */
        .mini-robot { display: inline-flex; align-items: center; position: relative; width: 32px; height: 36px; }
        .mini-robot .mr-head {
            width: 26px; height: 22px;
            background: linear-gradient(135deg, #1a1a2e, #16162a);
            border: 1.5px solid rgba(129,140,248,0.3);
            border-radius: 8px 8px 6px 6px;
            position: absolute; top: 6px; left: 50%; transform: translateX(-50%);
        }
        .mini-robot .mr-eye {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 6px var(--accent);
            position: absolute; top: 13px;
        }
        .mini-robot .mr-eye-l { left: 7px; }
        .mini-robot .mr-eye-r { right: 7px; }
        .mini-robot .mr-antenna {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 1.5px; height: 8px; background: rgba(129,140,248,0.3);
        }
        .mini-robot .mr-antenna::after {
            content:''; position:absolute; top:-3px; left:50%; transform:translateX(-50%);
            width:5px; height:5px; border-radius:50%; background:var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        .mini-robot .mr-body {
            width: 18px; height: 12px;
            background: linear-gradient(135deg, #1a1a2e, #16162a);
            border: 1.5px solid rgba(129,140,248,0.15);
            border-radius: 3px 3px 5px 5px;
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
        }
        .mini-robot.running .mr-eye { animation: pulse 2s ease-in-out infinite; }
        .mini-robot.running .mr-antenna::after { animation: pulse 1.5s ease-in-out infinite; }
        .mini-robot.idle { opacity: 0.5; }

        /* â”€â”€ Source badges â”€â”€ */
        .sources-bar {
            display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;
        }
        .source-tag {
            display: inline-flex; align-items: center; gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.65rem; font-weight: 500; letter-spacing: 0.03em;
            text-transform: uppercase;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text-2);
        }
        .source-tag .sdot {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--green);
            animation: pulse 3s ease-in-out infinite;
        }

        /* â”€â”€ Toast â”€â”€ */
        .toast-container {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            display: flex; flex-direction: column; gap: 0.5rem;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-size: 0.8rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: toastIn 0.4s cubic-bezier(0.16,1,0.3,1);
            max-width: 360px;
        }
        .toast-success { background: rgba(74,222,128,0.12); border: 1px solid rgba(74,222,128,0.2); color: var(--green); }
        .toast-error { background: rgba(248,113,113,0.12); border: 1px solid rgba(248,113,113,0.2); color: var(--red); }
        .toast-exit { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastIn { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
        @keyframes toastOut { to { opacity:0; transform:translateX(40px); } }

        /* â”€â”€ Story info box â”€â”€ */
        .story-box {
            background: rgba(129,140,248,0.05);
            border: 1px solid rgba(129,140,248,0.12);
            border-radius: 12px;
            padding: 0.75rem 1rem;
        }

        /* â”€â”€ Tweet preview area â”€â”€ */
        .tweet-preview { white-space: pre-wrap; line-height: 1.65; }

        /* â”€â”€ Chart â”€â”€ */
        .chart-wrap {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 0.5rem;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .chart-wrap:hover { transform: scale(1.01); }
        .chart-wrap img { border-radius: 10px; width: 100%; max-height: 400px; object-fit: contain; }

        /* â”€â”€ History item â”€â”€ */
        .history-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem 1.25rem;
            transition: border-color 0.3s, transform 0.2s;
        }
        .history-item:hover { border-color: var(--border-bright); transform: translateY(-1px); }

        /* â”€â”€ Step badges (setup) â”€â”€ */
        .step-circle {
            width: 22px; height: 22px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.6rem; font-weight: 700; flex-shrink: 0;
        }
        .step-done { background: rgba(74,222,128,0.15); color: var(--green); border: 1px solid rgba(74,222,128,0.25); }
        .step-todo { background: var(--surface-2); color: var(--text-3); border: 1px solid var(--border); }

        /* â”€â”€ Layout â”€â”€ */
        .page { position: relative; z-index: 2; }

        /* â”€â”€ Animations â”€â”€ */
        .fade-up {
            animation: fadeUp 0.6s cubic-bezier(0.16,1,0.3,1) both;
        }
        @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        .delay-1 { animation-delay: 0.05s; }
        .delay-2 { animation-delay: 0.1s; }
        .delay-3 { animation-delay: 0.15s; }
        .delay-4 { animation-delay: 0.2s; }

        /* â”€â”€ Scrollbar â”€â”€ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 768px) {
            .glass { padding: 1.25rem; border-radius: 16px; }
            .two-col { grid-template-columns: 1fr !important; }
            .nav-inner { flex-wrap: wrap; gap: 0.5rem; }
            .nav-right { display: none; }
            .nav-status { font-size: 0.7rem; }
        }
        @media (max-width: 480px) {
            .glass { padding: 1rem; }
        }
    </style>
</head>
<body>

    <div class="ambient"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>
    <div class="grain"></div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="page">

        <!-- â•â• NAV â•â• -->
        <nav style="border-bottom:1px solid var(--border); padding:0.9rem 1.5rem;">
            <div style="max-width:960px; margin:0 auto; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <div class="mini-robot {% if agent_running %}running{% else %}idle{% endif %}">
                        <div class="mr-antenna"></div>
                        <div class="mr-head"></div>
                        <div class="mr-eye mr-eye-l"></div>
                        <div class="mr-eye mr-eye-r"></div>
                        <div class="mr-body"></div>
                    </div>
                    <span class="font-display" style="font-weight:800; font-size:1.15rem; letter-spacing:-0.02em;">TweetAgent</span>
                    <span style="font-size:0.55rem; font-weight:600; letter-spacing:0.08em; text-transform:uppercase; color:var(--accent-2); border:1px solid rgba(167,139,250,0.2); padding:1px 6px; border-radius:4px;">v2</span>
                </div>
                <div style="display:flex; align-items:center; gap:1rem;">
                    <div id="headerStatus" style="display:flex; align-items:center; gap:0.4rem; font-size:0.78rem;">
                        {% if agent_running %}
                        <span class="dot dot-green dot-pulse"></span>
                        <span style="color:var(--green)">Running</span>
                        {% if next_run %}<span style="color:var(--text-3)">Â· Next: {{ next_run }}</span>{% endif %}
                        {% else %}
                        <span class="dot dot-red"></span>
                        <span style="color:var(--text-2)">Stopped</span>
                        {% endif %}
                    </div>
                    <div style="width:1px; height:16px; background:var(--border);"></div>
                    <div style="display:flex; align-items:center; gap:0.6rem; font-size:0.78rem;">
                        <span style="color:var(--text-2)">@{{ user.twitter_username or 'user' }}</span>
                        <a href="/auth/logout" style="color:var(--text-3); text-decoration:none; font-size:0.72rem; transition:color 0.2s;" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='var(--text-3)'">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <main style="max-width:960px; margin:0 auto; padding:1.75rem 1.5rem 3rem; display:flex; flex-direction:column; gap:1.25rem;">

            <!-- â•â• SETUP PROGRESS â•â• -->
            {% set has_anthropic = user.anthropic_api_key %}
            {% set has_twitter_dev = user.twitter_access_token %}
            {% set setup_complete = has_anthropic and has_twitter_dev %}
            {% if not setup_complete %}
            <div class="glass glass-glow fade-up" style="border-color:rgba(129,140,248,0.15);">
                <h2 class="section-title" style="margin-bottom:0.25rem;">Setup Your Agent</h2>
                <p class="section-sub" style="margin-bottom:1rem;">Complete these steps to start. You bring your own keys â€” the agent is free.</p>
                <div style="display:flex; align-items:center; gap:1.25rem; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span class="step-circle {% if has_anthropic %}step-done{% else %}step-todo{% endif %}">1</span>
                        <span style="font-size:0.8rem; color:{% if has_anthropic %}var(--green){% else %}var(--text-2){% endif %};">Anthropic Key</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span class="step-circle {% if user.perplexity_api_key %}step-done{% else %}step-todo{% endif %}">2</span>
                        <span style="font-size:0.8rem; color:{% if user.perplexity_api_key %}var(--green){% else %}var(--text-2){% endif %};">Perplexity <span style="font-size:0.65rem; color:var(--text-3);">(optional)</span></span>
                    </div>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span class="step-circle {% if has_twitter_dev %}step-done{% else %}step-todo{% endif %}">3</span>
                        <span style="font-size:0.8rem; color:{% if has_twitter_dev %}var(--green){% else %}var(--text-2){% endif %};">Twitter Dev Keys</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- â•â• AGENT CONTROL â•â• -->
            <div class="glass glass-glow fade-up delay-1">
                <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:1rem;">
                    <div>
                        <h2 class="section-title">Agent Control</h2>
                        <p class="section-sub">Start or stop your automated posting agent</p>
                    </div>
                    <div id="agentStatusBadge">
                        {% if agent_running %}
                        <span class="badge badge-green"><span class="dot dot-green dot-pulse"></span>Running</span>
                        {% else %}
                        <span class="badge badge-gray"><span class="dot dot-red"></span>Stopped</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Source monitors -->
                <div class="sources-bar" style="margin-bottom:1rem;">
                    <span style="font-size:0.68rem; color:var(--text-3); margin-right:0.25rem;">Sources:</span>
                    <span class="source-tag"><span class="sdot"></span>HackerNews</span>
                    <span class="source-tag"><span class="sdot"></span>TechCrunch</span>
                    <span class="source-tag"><span class="sdot"></span>Reddit</span>
                    <span class="source-tag"><span class="sdot"></span>BusinessWire</span>
                </div>

                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <button onclick="startAgent()" id="startBtn"
                        class="btn btn-brand {% if agent_running %}hidden{% endif %}">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><polygon points="5,3 19,10 5,17"/></svg>
                        Start Agent
                    </button>
                    <button onclick="stopAgent()" id="stopBtn"
                        class="btn btn-danger {% if not agent_running %}hidden{% endif %}">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><rect x="4" y="4" width="12" height="12" rx="1"/></svg>
                        Stop Agent
                    </button>
                    <span id="agentNextRun" style="font-size:0.78rem; color:var(--text-3);">
                        {% if agent_running and next_run %}Next post: {{ next_run }}{% endif %}
                    </span>
                </div>
            </div>

            <!-- â•â• PREVIEW & POST â•â• -->
            <div class="glass fade-up delay-2">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
                    <div>
                        <h2 class="section-title">Preview & Post</h2>
                        <p class="section-sub">Generate a preview, edit, then post</p>
                    </div>
                    <span id="charCount" class="badge badge-brand">0 chars</span>
                </div>

                <button onclick="generatePreview()" id="genBtn" class="btn btn-brand" style="margin-bottom:1rem;">
                    <span id="genBtnText">Generate Tweet</span>
                    <span id="genSpinner" class="spinner"></span>
                </button>

                <div id="previewArea" class="hidden">
                    <div id="storyInfoBox" class="story-box hidden" style="margin-bottom:0.75rem;">
                        <p id="storyInfo" style="font-size:0.82rem; color:var(--accent);"></p>
                        <a id="storyLink" href="#" target="_blank" style="font-size:0.7rem; color:var(--text-3); text-decoration:none; transition:color 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-3)'">View source &rarr;</a>
                    </div>

                    <div style="margin-bottom:0.75rem;">
                        <label class="label">Post Content</label>
                        <textarea id="tweetText" rows="12"
                            style="resize:none;"
                            class="tweet-preview"
                            placeholder="Your post will appear here..."></textarea>
                    </div>

                    <div id="chartPreview" class="hidden" style="margin-bottom:0.75rem;">
                        <label class="label">Chart Attachment</label>
                        <div class="chart-wrap">
                            <img id="chartImage" />
                        </div>
                    </div>

                    <div style="display:flex; gap:0.5rem; margin-top:0.75rem;">
                        <button onclick="postNow()" id="postBtn" class="btn btn-brand">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                            Post Now
                        </button>
                        <button onclick="generatePreview()" class="btn btn-ghost">Regenerate</button>
                    </div>
                </div>
            </div>

            <!-- â•â• TWO COLUMN: SETTINGS + API KEYS â•â• -->
            <div class="two-col" style="display:grid; grid-template-columns:1fr 1fr; gap:1.25rem;">

                <!-- Settings -->
                <div class="glass fade-up delay-3">
                    <h2 class="section-title" style="margin-bottom:1rem;">Settings</h2>
                    <form id="settingsForm" style="display:flex; flex-direction:column; gap:0.85rem;">
                        <div>
                            <label class="label">Topics (comma-separated)</label>
                            <input type="text" name="topics" value="{{ topics_list | join(', ') }}" placeholder="AI, funding, dev tools, startups">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.6rem;">
                            <div>
                                <label class="label">Tweets per day</label>
                                <select name="tweet_frequency">
                                    {% for i in range(1, 6) %}
                                    <option value="{{ i }}" {% if settings and settings.tweet_frequency == i %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="label">Style</label>
                                <select name="tweet_style">
                                    <option value="founder-focused" {% if settings and settings.tweet_style == 'founder-focused' %}selected{% endif %}>Builder & Startup</option>
                                    <option value="technical" {% if settings and settings.tweet_style == 'technical' %}selected{% endif %}>Technical</option>
                                    <option value="general" {% if settings and settings.tweet_style == 'general' %}selected{% endif %}>General</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.6rem;">
                            <div>
                                <label class="label">Schedule times</label>
                                <input type="text" name="schedule_times" value="{{ schedule_times | join(', ') }}" placeholder="09:00, 12:00">
                            </div>
                            <div>
                                <label class="label">Timezone</label>
                                <select name="timezone">
                                    <option value="America/Los_Angeles" {% if settings and settings.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific (LA)</option>
                                    <option value="America/New_York" {% if settings and settings.timezone == 'America/New_York' %}selected{% endif %}>Eastern (NY)</option>
                                    <option value="America/Chicago" {% if settings and settings.timezone == 'America/Chicago' %}selected{% endif %}>Central</option>
                                    <option value="Europe/London" {% if settings and settings.timezone == 'Europe/London' %}selected{% endif %}>London</option>
                                    <option value="Asia/Kolkata" {% if settings and settings.timezone == 'Asia/Kolkata' %}selected{% endif %}>India (IST)</option>
                                    <option value="UTC" {% if settings and settings.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-brand btn-full">Save Settings</button>
                    </form>
                </div>

                <!-- API Keys -->
                <div class="glass fade-up delay-4">
                    <h2 class="section-title" style="margin-bottom:1rem;">API Keys</h2>
                    <form id="setupForm" style="display:flex; flex-direction:column; gap:0.85rem;">

                        <!-- Anthropic -->
                        <div>
                            <div style="display:flex; align-items:center; gap:0.4rem; margin-bottom:0.35rem;">
                                <span class="label" style="margin-bottom:0;">Anthropic API Key</span>
                                {% if user.anthropic_api_key %}<span class="dot dot-green"></span>{% endif %}
                            </div>
                            <input type="password" name="anthropic_key" value="{{ user.anthropic_api_key or '' }}" placeholder="sk-ant-...">
                            <p class="help-text">Get at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a> (~$0.02/day)</p>
                        </div>

                        <!-- Perplexity -->
                        <div>
                            <div style="display:flex; align-items:center; gap:0.4rem; margin-bottom:0.35rem;">
                                <span class="label" style="margin-bottom:0;">Perplexity API Key</span>
                                <span style="font-size:0.62rem; color:var(--text-3);">(optional)</span>
                                {% if user.perplexity_api_key %}<span class="dot dot-green"></span>{% endif %}
                            </div>
                            <input type="password" name="perplexity_key" value="{{ user.perplexity_api_key or '' }}" placeholder="pplx-...">
                            <p class="help-text">Get at <a href="https://www.perplexity.ai/settings/api" target="_blank">perplexity.ai/settings/api</a></p>
                        </div>

                        <!-- Twitter Dev -->
                        <div style="border-top:1px solid var(--border); padding-top:0.85rem;">
                            <div style="display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                                <span class="label" style="margin-bottom:0; font-weight:500; color:var(--text-1);">Twitter Developer Credentials</span>
                                {% if user.twitter_access_token %}<span class="dot dot-green"></span>{% endif %}
                            </div>
                            <p class="help-text" style="margin-bottom:0.6rem;">
                                Get from <a href="https://developer.x.com/en/portal/dashboard" target="_blank">developer.x.com</a>:
                                Create project &rarr; Keys &amp; Tokens &rarr; Generate all 4
                            </p>
                            <div style="display:flex; flex-direction:column; gap:0.5rem;">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                                    <div>
                                        <label style="font-size:0.65rem; color:var(--text-3); display:block; margin-bottom:0.2rem;">API Key</label>
                                        <input type="password" name="twitter_api_key" value="{{ user.twitter_api_key or '' }}" placeholder="Consumer key...">
                                    </div>
                                    <div>
                                        <label style="font-size:0.65rem; color:var(--text-3); display:block; margin-bottom:0.2rem;">API Secret</label>
                                        <input type="password" name="twitter_api_secret" value="{{ user.twitter_api_secret or '' }}" placeholder="Consumer secret...">
                                    </div>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                                    <div>
                                        <label style="font-size:0.65rem; color:var(--text-3); display:block; margin-bottom:0.2rem;">Access Token</label>
                                        <input type="password" name="twitter_access_token" value="{{ user.twitter_access_token or '' }}" placeholder="Access token...">
                                    </div>
                                    <div>
                                        <label style="font-size:0.65rem; color:var(--text-3); display:block; margin-bottom:0.2rem;">Access Token Secret</label>
                                        <input type="password" name="twitter_access_token_secret" value="{{ user.twitter_access_token_secret or '' }}" placeholder="Token secret...">
                                    </div>
                                </div>
                            </div>
                            <p class="help-text" style="margin-top:0.4rem;">Free tier: 1,500 tweets/month. Needs Read+Write.</p>
                        </div>

                        <button type="submit" class="btn btn-brand btn-full">Save API Keys</button>
                    </form>
                </div>
            </div>

            <!-- â•â• ADMIN: USERS TABLE (owner only) â•â• -->
            {% if user.is_owner and all_users %}
            <div class="glass fade-up">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
                    <div>
                        <h2 class="section-title">Users</h2>
                        <p class="section-sub">People using TweetAgent &mdash; {{ all_users|length }} total</p>
                    </div>
                    <span class="badge badge-brand">Admin</span>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.82rem;">
                        <thead>
                            <tr style="border-bottom:1px solid var(--border);">
                                <th style="text-align:left; padding:0.6rem 0.75rem; font-weight:600; color:var(--text-2); font-size:0.72rem; text-transform:uppercase; letter-spacing:0.05em;">#</th>
                                <th style="text-align:left; padding:0.6rem 0.75rem; font-weight:600; color:var(--text-2); font-size:0.72rem; text-transform:uppercase; letter-spacing:0.05em;">Twitter Handle</th>
                                <th style="text-align:center; padding:0.6rem 0.75rem; font-weight:600; color:var(--text-2); font-size:0.72rem; text-transform:uppercase; letter-spacing:0.05em;">Tweets</th>
                                <th style="text-align:left; padding:0.6rem 0.75rem; font-weight:600; color:var(--text-2); font-size:0.72rem; text-transform:uppercase; letter-spacing:0.05em;">Joined</th>
                                <th style="text-align:center; padding:0.6rem 0.75rem; font-weight:600; color:var(--text-2); font-size:0.72rem; text-transform:uppercase; letter-spacing:0.05em;">Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in all_users %}
                            <tr style="border-bottom:1px solid var(--border); transition:background 0.2s;" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
                                <td style="padding:0.65rem 0.75rem; color:var(--text-3);">{{ loop.index }}</td>
                                <td style="padding:0.65rem 0.75rem;">
                                    {% if u.username != 'â€”' %}
                                    <a href="https://x.com/{{ u.username }}" target="_blank" style="color:var(--accent); text-decoration:none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">@{{ u.username }}</a>
                                    {% else %}
                                    <span style="color:var(--text-3);">{{ u.username }}</span>
                                    {% endif %}
                                </td>
                                <td style="padding:0.65rem 0.75rem; text-align:center;">
                                    <span class="badge {% if u.tweet_count > 0 %}badge-green{% else %}badge-gray{% endif %}" style="padding:0.15rem 0.6rem; font-size:0.72rem;">{{ u.tweet_count }}</span>
                                </td>
                                <td style="padding:0.65rem 0.75rem; color:var(--text-2); font-size:0.78rem;">
                                    {% if u.created_at %}{{ u.created_at.strftime('%b %d, %Y') }}{% else %}â€”{% endif %}
                                </td>
                                <td style="padding:0.65rem 0.75rem; text-align:center;">
                                    {% if u.is_owner %}
                                    <span class="badge badge-brand" style="padding:0.15rem 0.5rem; font-size:0.65rem;">Owner</span>
                                    {% else %}
                                    <span style="font-size:0.75rem; color:var(--text-3);">User</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- â•â• TWEET HISTORY â•â• -->
            <div class="glass fade-up">
                <h2 class="section-title" style="margin-bottom:1rem;">Tweet History</h2>
                <div style="display:flex; flex-direction:column; gap:0.6rem;" id="historyList">
                    {% if tweets %}
                    {% for tweet in tweets %}
                    <div class="history-item">
                        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:0.75rem;">
                            <p style="font-size:0.82rem; color:var(--text-2); flex:1; line-height:1.6;" class="tweet-preview">{{ tweet.tweet_text[:500] }}{% if tweet.tweet_text|length > 500 %}...{% endif %}</p>
                            <span class="dot {% if tweet.status == 'posted' %}dot-green{% elif tweet.status == 'failed' %}dot-red{% else %}dot-yellow{% endif %}" style="margin-top:0.3rem;" title="{{ tweet.status }}"></span>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.75rem; margin-top:0.5rem; font-size:0.7rem; color:var(--text-3);">
                            {% if tweet.posted_at %}
                            <span>{{ tweet.posted_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                            {% endif %}
                            {% if tweet.tweet_text|length > 280 %}
                            <span class="badge badge-brand" style="padding:0.15rem 0.5rem; font-size:0.62rem;">{{ tweet.tweet_text|length }} chars</span>
                            {% endif %}
                            {% if tweet.tweet_id %}
                            <a href="https://x.com/i/status/{{ tweet.tweet_id }}" target="_blank" style="color:var(--accent); text-decoration:none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">View on X &rarr;</a>
                            {% endif %}
                            {% if tweet.story_url %}
                            <a href="{{ tweet.story_url }}" target="_blank" style="color:var(--text-3); text-decoration:none;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-3)'">Source &rarr;</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div style="text-align:center; padding:2rem 0;">
                        <div style="font-size:2.5rem; margin-bottom:0.5rem; opacity:0.3;">ðŸ¤–</div>
                        <p style="font-size:0.85rem; color:var(--text-2);">No tweets yet</p>
                        <p style="font-size:0.75rem; color:var(--text-3); margin-top:0.25rem;">Generate your first post above to get started</p>
                    </div>
                    {% endif %}
                </div>
            </div>

        </main>

        <footer style="border-top:1px solid var(--border); padding:1.5rem; text-align:center;">
            <p style="font-size:0.68rem; color:var(--text-3); letter-spacing:0.02em;">TweetAgent v2 &mdash; AI-powered posting for builders & startups</p>
        </footer>
    </div>

    <script>
        let currentChartUrl = '';

        // â”€â”€ Toast system â”€â”€
        function toast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = message;
            container.appendChild(el);
            setTimeout(() => { el.classList.add('toast-exit'); setTimeout(() => el.remove(), 300); }, 4000);
        }

        // â”€â”€ Agent Start / Stop â”€â”€
        async function startAgent() {
            const btn = document.getElementById('startBtn');
            btn.textContent = 'Starting...'; btn.disabled = true;
            try {
                const resp = await fetch('/api/agent/start', { method: 'POST' });
                if (resp.status === 401) { window.location = '/login'; return; }
                const data = await resp.json();
                if (data.error) { toast(data.error, 'error'); }
                else {
                    toast(data.message);
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    document.getElementById('agentNextRun').textContent = data.next_run ? `Next post: ${data.next_run}` : '';
                    updateHeaderStatus(true, data.next_run);
                    updateAgentBadge(true);
                    updateRobot(true);
                }
            } catch (e) { toast('Failed: ' + e.message, 'error'); }
            finally {
                btn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><polygon points="5,3 19,10 5,17"/></svg> Start Agent`;
                btn.disabled = false;
            }
        }

        async function stopAgent() {
            const btn = document.getElementById('stopBtn');
            btn.textContent = 'Stopping...'; btn.disabled = true;
            try {
                const resp = await fetch('/api/agent/stop', { method: 'POST' });
                if (resp.status === 401) { window.location = '/login'; return; }
                const data = await resp.json();
                if (data.error) { toast(data.error, 'error'); }
                else {
                    toast(data.message);
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('startBtn').classList.remove('hidden');
                    document.getElementById('agentNextRun').textContent = '';
                    updateHeaderStatus(false);
                    updateAgentBadge(false);
                    updateRobot(false);
                }
            } catch (e) { toast('Failed: ' + e.message, 'error'); }
            finally {
                btn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><rect x="4" y="4" width="12" height="12" rx="1"/></svg> Stop Agent`;
                btn.disabled = false;
            }
        }

        function updateHeaderStatus(running, nextRun) {
            const el = document.getElementById('headerStatus');
            if (running) {
                el.innerHTML = `<span class="dot dot-green dot-pulse"></span><span style="color:var(--green)">Running</span>${nextRun ? `<span style="color:var(--text-3)">Â· Next: ${nextRun}</span>` : ''}`;
            } else {
                el.innerHTML = `<span class="dot dot-red"></span><span style="color:var(--text-2)">Stopped</span>`;
            }
        }

        function updateAgentBadge(running) {
            const el = document.getElementById('agentStatusBadge');
            el.innerHTML = running
                ? `<span class="badge badge-green"><span class="dot dot-green dot-pulse"></span>Running</span>`
                : `<span class="badge badge-gray"><span class="dot dot-red"></span>Stopped</span>`;
        }

        function updateRobot(running) {
            const robot = document.querySelector('.mini-robot');
            if (robot) { robot.className = `mini-robot ${running ? 'running' : 'idle'}`; }
        }

        // â”€â”€ Generate Preview â”€â”€
        async function generatePreview() {
            const btn = document.getElementById('genBtn');
            const spinner = document.getElementById('genSpinner');
            const btnText = document.getElementById('genBtnText');
            btnText.textContent = 'Generating...'; spinner.classList.add('active'); btn.disabled = true;
            try {
                const resp = await fetch('/api/generate-preview', { method: 'POST' });
                if (resp.status === 401) { window.location = '/login'; return; }
                const data = await resp.json();
                if (data.error) { toast(data.error, 'error'); return; }

                document.getElementById('tweetText').value = data.tweet;
                document.getElementById('charCount').textContent = `${data.chars} chars`;
                document.getElementById('previewArea').classList.remove('hidden');

                if (data.story_title) {
                    document.getElementById('storyInfo').textContent = `Source: ${data.story_title}`;
                    document.getElementById('storyInfoBox').classList.remove('hidden');
                    if (data.story_url) {
                        document.getElementById('storyLink').href = data.story_url;
                        document.getElementById('storyLink').classList.remove('hidden');
                    }
                }

                if (data.chart_url) {
                    document.getElementById('chartImage').src = data.chart_url;
                    document.getElementById('chartPreview').classList.remove('hidden');
                    currentChartUrl = data.chart_url;
                } else {
                    document.getElementById('chartPreview').classList.add('hidden');
                    currentChartUrl = '';
                }
                toast('Tweet generated!');
            } catch (e) { toast('Generation failed: ' + e.message, 'error'); }
            finally { btnText.textContent = 'Generate Tweet'; spinner.classList.remove('active'); btn.disabled = false; }
        }

        // â”€â”€ Post Now â”€â”€
        async function postNow() {
            const tweet = document.getElementById('tweetText').value;
            if (!tweet) return;
            const postBtn = document.getElementById('postBtn');
            postBtn.textContent = 'Posting...'; postBtn.disabled = true;
            try {
                const formData = new FormData();
                formData.append('tweet_text', tweet);
                formData.append('chart_url', currentChartUrl);
                const resp = await fetch('/api/post-now', { method: 'POST', body: formData });
                if (resp.status === 401) { window.location = '/login'; return; }
                const data = await resp.json();
                if (data.error) { toast(data.error, 'error'); }
                else { toast(`Tweet posted! ID: ${data.tweet_id}`); setTimeout(() => location.reload(), 2000); }
            } catch (e) { toast('Post failed: ' + e.message, 'error'); }
            finally {
                postBtn.innerHTML = `<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Post Now`;
                postBtn.disabled = false;
            }
        }

        // â”€â”€ Char count â”€â”€
        document.getElementById('tweetText')?.addEventListener('input', function() {
            document.getElementById('charCount').textContent = `${this.value.length} chars`;
        });

        // â”€â”€ Settings form â”€â”€
        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const resp = await fetch('/api/settings', { method: 'POST', body: new FormData(this) });
                if (resp.status === 401) { window.location = '/login'; return; }
                const data = await resp.json();
                toast(data.message || data.error, data.error ? 'error' : 'success');
            } catch (e) { toast('Failed: ' + e.message, 'error'); }
        });

        // â”€â”€ Setup form (API keys) â”€â”€
        document.getElementById('setupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const resp = await fetch('/api/setup', { method: 'POST', body: new FormData(this) });
                if (resp.status === 401) { window.location = '/login'; return; }
                const data = await resp.json();
                toast(data.message || data.error, data.error ? 'error' : 'success');
                if (!data.error) { setTimeout(() => location.reload(), 1500); }
            } catch (e) { toast('Failed: ' + e.message, 'error'); }
        });

        // â”€â”€ Hidden util â”€â”€
        document.querySelectorAll('.hidden').forEach(el => { /* tailwind hidden class */ });
    </script>
</body>
</html>
